<style>
  
    .modal-container {
        display: none;
        position: fixed;
        z-index: 1;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0,0,0,0.8);
    }

    .modal-content {
        background-color:  var(--bg2);
        margin: 8% auto;
        padding: 20px;
        border-radius: 5px;
        box-shadow: 0px 0px 5px rgba(0,0,0,0.2);
        max-width: 700px;
    }

    .close {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
        transition: all 0.3s ease;
    }

    .close:hover,
    .close:focus {
        color: black;
        text-decoration: none;
        cursor: pointer;
        transform: scale(1.2);
    }

   .table {
    width: 100%;
   }

  .task-details-table, .sub-details-table {
      table-layout: fixed; /* Controla o layout da tabela */
      width: 100%; /* Faz a tabela ocupar 100% da largura da div */
      word-wrap: break-word; /* Força a quebra de palavras */
      border-collapse: collapse; /* Evita espaços duplicados entre as células */
  }

  .task-details-table th, .task-details-table td,
  .sub-details-table th, .sub-details-table td {
      border: 1px solid #ddd; /* Borda fina para melhor visibilidade */
      padding: 3px; /* Espaçamento interno */
      text-align: left; /* Alinha o texto à esquerda */
  }

  .task-details-table th {
      background-color: #f2f2f2; /* Cor de fundo para o cabeçalho */
      font-weight: bold; /* Destaque no texto */
  }

  .sub-details-table td {
      font-size: 90%; /* Reduz um pouco o tamanho da fonte */
  }

</style>


<div id="myModal" class="modal-container">
    <div class="modal-content">
        <span class="close">&times;</span>
            <div id="conteudoDivModal" style="margin: auto;text-align: center;align-items: center;">
                <input type="text" id="id_selecionado" value="999999" disabled style="text-align:center;">
                <br><br>
                <p style='font-size:9px;'><b>Botões funcionam com duplo click</b></p>
                <button id="btnReiniciar" class="bt1" ondblclick="resetar_tarefa_modal_grafico1();">&nbsp;Reiniciar Tarefa&nbsp;</button>
                <button id="btnReiniciarCadeia" class="bt1" ondblclick="resetar_cadeia_modal_grafico1();">&nbsp;Reiniciar Toda Cadeia&nbsp;</button>
                <button id="btnIniciar" class="bt1" ondblclick="forca_inicio();">&nbsp;Forçar Inicio Tarefa&nbsp;</button><br><br>  
                <div id="ind_atualizacao"></div>              
            </div>
            <br>

            <div id="container-tabela"></div>        
            <div id="mensagem_modal_x"></div>  
    </div>
    
</div>

<script>


    var modal = document.getElementById("myModal");
    var span = document.getElementsByClassName("close")[0];

    function chamar_modal_id(id){
        if (isNaN(id)){
            id = '0'
        };
        modal.style.display = "block";
        const id_selecionado = document.getElementById("id_selecionado");
        id_selecionado.value = String(id)
        buscarDetalhesTarefa(String(id_selecionado.value))
    };

    span.onclick = function() {
        modal.style.display = "none";
        let id_selecionado = document.getElementById("id_selecionado");
        id_selecionado.value = '0';        
    }

    window.onclick = function(event) {
        if (event.target == modal) {
            modal.style.display = "none";
            let id_selecionado = document.getElementById("id_selecionado");
            id_selecionado.value = '0';            
        }
    }

    function buscarDetalhesTarefa(idTarefa) {
    if (!idTarefa) {
        alert('Não recebeu ID da tarefa.');
        console.error('ID da tarefa é obrigatório.');
        $('#container-tabela').text('Parâmetros inválidos.');
        return;
    }

    const $container = $('#container-tabela');
    $.ajax({
        url: 'flow_pesq_id',
        method: 'GET',
        data: { id_tarefa: idTarefa },
        dataType: 'json',
        beforeSend() {
            $container.html(`
                <div class="loader">
                    <div class="dot"></div><div class="dot"></div><div class="dot"></div>
                </div>
            `);
        },
        success(response) {
            const registros = Array.isArray(response)
                ? response
                : (response.data?.task_details || []);
            if (!registros.length) {
                $container.text('Nenhum detalhe de tarefa encontrado.');
                return;
            }

            const taskDetails = registros[0];
            const $table = $('<table>').addClass('task-details-table')
                .append('<thead><tr><th>Campo</th><th>Valor</th></tr></thead>');
            const $tbody = $('<tbody>');
            const host = `http://${location.host}`;
            const tiposLinks = {
                '1':'wrk_01_tf','2':'wrk_02_up_gcp','3':'wrk_03_down_gcp',
                '4':'wrk_04_procedure_gcp','5':'wrk_05_script_py','6':'wrk_06_script_sas',
                '7':'wrk_07_excel_vba','8':'wrk_08_up_srv_sas','9':'wrk_09_down_srv_sas',
                '10':'wrk_10_script_vbs','11':'wrk_11_funcao_true_py',
                '12':'wrk_12_gcp_csv_tbl','13':'wrk_13_tf_mft'
            };
            const rotulos = {
                'txt_bucket_dir':'Bucket','txt_ini_arq':'Início Arquivo',
                'txt_lista_header':'Cabeçalho','txt_seperador':'Separador',
                'txt_tabela_destino':'Tabela Destino','txt_recriar_tabela':'Recriar Tabela',
                'txt_linha_cabecalho':'Linha Cabeçalho',
                'txt_lista_validar_duplicidade':'Colunas Valida Duplicidade'
            };

            let servico = '', tarefaId = '', linkHtml = '';
            const chaves = Object.keys(taskDetails);
            chaves.forEach(chave => {
                const valor = taskDetails[chave];
                const $tr = $('<tr>');
                $('<td>').text(chave).appendTo($tr);

                if (chave === 'Código Serviço') servico = valor.trim();
                if (chave === 'ID Tarefa') tarefaId = valor.trim();
                if (servico && tarefaId) {
                    const href = `${host}/${tiposLinks[servico]}?linha=${tarefaId}`;
                    linkHtml = `<a class="btn_tab logs" style="font-size:12px;text-decoration:none" href="${href}" target="_blank">${tarefaId}</a>`;
                    servico = ''; tarefaId = '';
                }

                let parsed;
                try { parsed = JSON.parse(valor); }
                catch { parsed = null; }

                const $tdValor = $('<td>');
                if (parsed && typeof parsed === 'object') {
                    const $sub = $('<table>').addClass('sub-details-table');
                    Object.keys(parsed).forEach(subChave => {
                        const subVal = parsed[subChave];
                        const $trSub = $('<tr>');
                        $('<td>').text(rotulos[subChave] || subChave).appendTo($trSub);
                        $('<td>').html(subVal || '').appendTo($trSub);
                        $sub.append($trSub);
                    });
                    $tdValor.append($sub);
                } else {
                    $tdValor.html(linkHtml || valor);
                    linkHtml = '';
                }

                $tr.append($tdValor);
                $tbody.append($tr);
            });

            $table.append($tbody);
            $container.empty().append($table);
        },
        error(xhr, status, err) {
            console.error('Erro de comunicação ou processamento:', err);
            $('#container-tabela').text('Erro ao buscar detalhes da tarefa.');
        }
    });
}





</script>